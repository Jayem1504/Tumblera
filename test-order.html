<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Order - Tumblera</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-3xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold mb-6">üß™ Test Order Submission</h1>
            
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                <p class="font-bold">‚ö†Ô∏è Important: Run the SQL fix first!</p>
                <p class="text-sm mt-1">See <code class="bg-yellow-100 px-2 py-1 rounded">FIX_ORDERS.md</code> for instructions</p>
            </div>

            <div id="status" class="mb-6"></div>

            <button onclick="testOrder()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-medium mb-4">
                üöÄ Test Order Submission
            </button>

            <button onclick="checkTable()" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-medium mb-4">
                üìä Check Orders Table
            </button>

            <a href="cart.html" class="block w-full bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 font-medium text-center">
                üõí Go to Cart Page
            </a>

            <div class="mt-8 p-4 bg-gray-50 rounded">
                <h3 class="font-bold mb-2">Console Output:</h3>
                <div id="console" class="bg-black text-green-400 p-4 rounded font-mono text-sm h-64 overflow-auto">
                    Waiting for test...
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const colors = {
                info: 'text-green-400',
                success: 'text-green-300',
                error: 'text-red-400',
                warning: 'text-yellow-400'
            };
            
            const timestamp = new Date().toLocaleTimeString();
            console.innerHTML += `<div class="${colors[type]}">[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            const colors = {
                success: 'bg-green-100 border-green-400 text-green-700',
                error: 'bg-red-100 border-red-400 text-red-700',
                info: 'bg-blue-100 border-blue-400 text-blue-700',
                warning: 'bg-yellow-100 border-yellow-400 text-yellow-700'
            };
            
            status.innerHTML = `
                <div class="border-l-4 p-4 ${colors[type]}">
                    ${message}
                </div>
            `;
        }

        window.testOrder = async function() {
            log('Starting order test...', 'info');
            showStatus('‚è≥ Testing order submission...', 'info');
            
            try {
                // Import Supabase function
                log('Importing Supabase module...', 'info');
                const { saveOrder, supabase } = await import('./js/supabase.js');
                
                // Test data
                const testOrder = {
                    name: 'Test Customer',
                    email: 'test@example.com',
                    phone: '1234567890',
                    address: '123 Test Street, Test City, TC 12345',
                    items: JSON.stringify([
                        {
                            id: 1,
                            design: {
                                text: 'Test Order',
                                font: 'Arial',
                                textColor: '#000000',
                                tumblerColor: '#ffffff'
                            },
                            price: 24.99
                        }
                    ]),
                    total: 29.99
                };
                
                log('Test order data prepared:', 'success');
                log(JSON.stringify(testOrder, null, 2), 'info');
                
                log('Calling saveOrder()...', 'info');
                const result = await saveOrder(testOrder);
                
                log('Result received:', 'info');
                log(JSON.stringify(result, null, 2), 'info');
                
                if (result.success) {
                    log('‚úÖ ORDER SAVED SUCCESSFULLY!', 'success');
                    log('Order ID: ' + result.order.id, 'success');
                    showStatus(
                        `<p class="font-bold">‚úÖ SUCCESS!</p>
                        <p class="mt-2">Order ID: <code class="bg-green-200 px-2 py-1 rounded">${result.order.id}</code></p>
                        <p class="mt-2">Check your Supabase Table Editor ‚Üí orders table</p>`,
                        'success'
                    );
                } else {
                    log('‚ùå ORDER SAVE FAILED', 'error');
                    log('Error: ' + result.error, 'error');
                    showStatus(
                        `<p class="font-bold">‚ùå FAILED</p>
                        <p class="mt-2">Error: ${result.error}</p>
                        <p class="mt-2">Check FIX_ORDERS.md for solutions</p>`,
                        'error'
                    );
                }
            } catch (error) {
                log('‚ùå EXCEPTION CAUGHT', 'error');
                log('Error: ' + error.message, 'error');
                log('Stack: ' + error.stack, 'error');
                showStatus(
                    `<p class="font-bold">‚ùå ERROR</p>
                    <p class="mt-2">${error.message}</p>
                    <p class="mt-2">Check console and FIX_ORDERS.md</p>`,
                    'error'
                );
            }
        };

        window.checkTable = async function() {
            log('Checking orders table...', 'info');
            showStatus('‚è≥ Checking orders table...', 'info');
            
            try {
                const { supabase } = await import('./js/supabase.js');
                
                log('Querying orders table...', 'info');
                const { data, error } = await supabase
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (error) {
                    log('‚ùå Query failed: ' + error.message, 'error');
                    showStatus(
                        `<p class="font-bold">‚ùå Query Failed</p>
                        <p class="mt-2">${error.message}</p>
                        <p class="mt-2">Common issue: Table doesn't exist or RLS is blocking</p>`,
                        'error'
                    );
                } else {
                    log('‚úÖ Query successful!', 'success');
                    log(`Found ${data.length} order(s)`, 'success');
                    
                    if (data.length > 0) {
                        log('Latest orders:', 'info');
                        data.forEach((order, i) => {
                            log(`${i + 1}. ${order.customer_name} - $${order.total_amount} - ${order.status}`, 'info');
                        });
                        
                        showStatus(
                            `<p class="font-bold">‚úÖ Found ${data.length} order(s)</p>
                            <p class="mt-2">Latest: ${data[0].customer_name} - $${data[0].total_amount}</p>
                            <p class="mt-2">Check Supabase Table Editor for full details</p>`,
                            'success'
                        );
                    } else {
                        log('‚ö†Ô∏è No orders found in table', 'warning');
                        showStatus(
                            `<p class="font-bold">‚ö†Ô∏è No Orders Yet</p>
                            <p class="mt-2">Table exists but is empty</p>
                            <p class="mt-2">Try the "Test Order Submission" button above</p>`,
                            'warning'
                        );
                    }
                }
            } catch (error) {
                log('‚ùå Exception: ' + error.message, 'error');
                showStatus(
                    `<p class="font-bold">‚ùå Error</p>
                    <p class="mt-2">${error.message}</p>`,
                    'error'
                );
            }
        };

        // Clear console on load
        window.addEventListener('load', () => {
            document.getElementById('console').innerHTML = 'üîß Test utility ready. Click a button to start.\n';
        });
    </script>
</body>
</html>
